# Workflow for Automated Release and Changelog Generation
name: Release and Changelog

on:
  push:
    branches:
      - main

jobs:
  release:
    if: ${{ github.ref != 'refs/heads/release-automation' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install dependencies
        run: npm ci
      - name: Set git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      - name: Run standard-version
        run: npx standard-version
      - name: Check and delete existing release-automation branch
        run: |
          if git ls-remote --exit-code --heads origin release-automation; then
            echo "Branch release-automation exists. Deleting it..."
            git push origin --delete release-automation
          else
            echo "Branch release-automation does not exist. Proceeding..."
          fi
      - name: Create Pull Request for Release
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'chore(release): bump version and update changelog'
          title: 'chore(release): bump version and update changelog'
          body: 'Automated release PR generated by GitHub Actions.'
          branch: 'release-automation'
          delete-branch: true
          token: ${{ secrets.GITHUB_TOKEN }}
